generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum JobType {
  INBOUND
  OUTBOUND
  RETURN
  MOVE
  ADJUST
}

// 직원 역할
enum EmployeeRole {
  MASTER  // 최고 관리자 (1명, .env로 고정, 삭제/강등 불가)
  ADMIN   // 관리자 (MASTER가 지정, 직원 승인 가능)
  STAFF   // 직원 (ADMIN이 승인)
}

// 직원 상태
enum EmployeeStatus {
  ACTIVE    // 승인됨
  PENDING   // 승인대기
  DISABLED  // 비활성화
}

model Store {
  id        String     @id @default(cuid())
  code      String     @unique  // 매장코드 (HQ, 4000, 4100...)
  name      String?              // 매장명
  isHq      Boolean    @default(false)  // 본사 창고 여부
  locations Location[]
  jobs      Job[]
  employees Employee[]
}

// 본사 부서
model Department {
  id        String   @id @default(cuid())
  code      String   @unique  // 부서코드 (LOGISTICS, SALES, MARKETING...)
  name      String             // 부서명
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employees Employee[]
}

// 통합 직원 모델 (Firebase Auth 연동 + 권한 관리)
model Employee {
  id           String   @id @default(cuid())
  firebaseUid  String?  @unique  // Firebase Auth UID (가입 전이면 null)
  storeId      String?           // 소속 매장 (매장 직원용)
  departmentId String?           // 소속 부서 (본사 직원용)
  isHq         Boolean  @default(false)  // 본사 여부 (true=본사, false=매장)

  name        String             // 이름 (필수)
  phone       String?            // 연락처
  email       String?            // 이메일
  pushToken   String?            // FCM 푸시 토큰

  role        EmployeeRole   @default(STAFF)
  status      EmployeeStatus @default(PENDING)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store       Store?      @relation(fields: [storeId], references: [id], onDelete: SetNull)
  department  Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  events      Event[]
  boardPosts  BoardPost[]
  messages    Message[]   @relation("MessageAuthor")
  receipts    Receipt[]   @relation("ReceiptEmployee")
  approvals   Approval[]  @relation("ApprovalAuthor")
  approverFor ApprovalApprover[] @relation("ApprovalApprover")

  @@index([storeId], map: "Employee_storeId_idx")
  @@index([departmentId], map: "Employee_departmentId_idx")
  @@index([firebaseUid], map: "Employee_firebaseUid_idx")
  @@index([status], map: "Employee_status_idx")
  @@index([role], map: "Employee_role_idx")
}

model Location {
  id      String @id @default(cuid())
  storeId String
  code    String
  name    String?

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  inventories  Inventory[]
  inventoryTxs InventoryTx[]

  @@unique([storeId, code], map: "Location_storeId_code_key")
  @@index([storeId], map: "Location_storeId_idx")
  @@index([code], map: "Location_code_idx")
}

model Sku {
  id          String  @id @default(cuid())
  sku         String  @unique // SKU 코드
  makerCode   String? // 바코드/메이커코드 (통합)
  name        String?
  productType String  @default("SHOES")

  inventories  Inventory[]
  inventoryTxs InventoryTx[]
  jobItems     JobItem[]

  @@index([makerCode], map: "Sku_makerCode_idx")
}

model Inventory {
  id         String @id @default(cuid())
  skuId      String
  locationId String
  qty        Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sku      Sku      @relation(fields: [skuId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([skuId, locationId], map: "Inventory_skuId_locationId_key")
  @@index([skuId], map: "Inventory_skuId_idx")
  @@index([locationId], map: "Inventory_locationId_idx")
}

model InventoryTx {
  id         String  @id @default(cuid())
  type       String // 'in' | 'out' | 'move' | 'adjust' 등
  qty        Int
  skuId      String
  locationId String?

  // 강제출고(0유지)용 로그
  isForced     Boolean @default(false)
  forcedReason String?
  beforeQty    Int?
  afterQty     Int?

  // 추적용
  jobId     String?
  jobItemId String?

  // undo용
  undoneAt   DateTime?
  undoneTxId String?

  // 작업자 ID (MVP: 로그인 없이 단순 기록용)
  operatorId String?

  // ✅ [추가] 거래 메모 (수동 조정 사유 등)
  note String?

  // ✅ [추가] 스캔 디바이스 ID (터미널 추적)
  deviceId String?

  createdAt DateTime @default(now())

  sku      Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  job     Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  jobItem JobItem? @relation(fields: [jobItemId], references: [id], onDelete: SetNull)

  @@index([createdAt], map: "InventoryTx_createdAt_idx")
  @@index([skuId], map: "InventoryTx_skuId_idx")
  @@index([locationId], map: "InventoryTx_locationId_idx")
  @@index([isForced], map: "InventoryTx_isForced_idx")
  @@index([jobId], map: "InventoryTx_jobId_idx")
  @@index([jobItemId], map: "InventoryTx_jobItemId_idx")
  @@index([undoneAt], map: "InventoryTx_undoneAt_idx")
  @@index([undoneTxId], map: "InventoryTx_undoneTxId_idx")
  @@index([operatorId], map: "InventoryTx_operatorId_idx")
  // ✅ [추가] UNDO 성능 개선용 복합 인덱스
  @@index([jobId, createdAt(sort: Desc)], map: "InventoryTx_jobId_createdAt_idx")
}

model Job {
  id            String  @id @default(cuid())
  storeId       String  // 매장 FK
  store         Store   @relation(fields: [storeId], references: [id])
  allowOverpick Boolean @default(false)
  title         String?
  memo          String?
  cjShipment    CjShipment?

  // 'open' | 'picking' | 'done' | 'cancelled'
  status String @default("open")

  // Job 타입 (입고/출고/반품/이동/조정)
  type JobType @default(OUTBOUND)

  // 작업자 ID (MVP: 로그인 없이 단순 기록용)
  operatorId String?

  // ✅ [추가] 작업 우선순위 (0=일반, 1=높음, 2=긴급)
  priority Int @default(0)

  // ✅ [추가] 판매채널 ("STORE" | "ONLINE" | "COUPANG" 등)
  channel String?

  // ✅ [추가] 의뢰요청일
  requestDate DateTime?

  // ✅ [추가] 배치(묶음) Job 관계 - 택배 작업용
  parentId String?
  parent   Job?  @relation("JobHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Job[] @relation("JobHierarchy")

  // ✅ [추가] 택배 작업용 - 단포/합포 구분 및 정렬
  packType  String? // "single" | "multi" (null이면 배치 Job)
  sortOrder Int     @default(0) // 단포=1, 합포=2 (스캔 우선순위)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  doneAt    DateTime?

  // ✅ [추가] 작업 시작 시간 (첫 스캔 시 기록)
  workStartedAt DateTime?

  items  JobItem[]
  parcel JobParcel?
  txs    InventoryTx[]

  @@index([storeId], map: "Job_storeId_idx")
  @@index([doneAt], map: "Job_doneAt_idx")
  @@index([type], map: "Job_type_idx")
  @@index([operatorId], map: "Job_operatorId_idx")
  @@index([priority], map: "Job_priority_idx")
  @@index([channel], map: "Job_channel_idx")
  @@index([parentId], map: "Job_parentId_idx")
  @@index([packType], map: "Job_packType_idx")
  @@index([sortOrder], map: "Job_sortOrder_idx")
}

model JobItem {
  id    String @id @default(cuid())
  jobId String
  skuId String

  qtyPlanned Int
  qtyPicked  Int @default(0)

  makerCodeSnapshot String?
  nameSnapshot      String?

  // 추가피킹(Planned 초과) 승인/사용
  extraApprovedQty Int @default(0)
  extraPickedQty   Int @default(0)

  // ✅ [추가] 예상 픽업 위치 가이드
  locationHint String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  sku Sku @relation(fields: [skuId], references: [id], onDelete: Cascade)

  txs InventoryTx[]

  @@unique([jobId, skuId], map: "JobItem_jobId_skuId_key")
  @@index([jobId], map: "JobItem_jobId_idx")
  @@index([skuId], map: "JobItem_skuId_idx")
}

model JobParcel {
  id    String @id @default(cuid())
  jobId String @unique

  orderNo       String?
  recipientName String
  phone         String
  zip           String?
  addr1         String
  addr2         String?
  memo          String?

  carrierCode String?
  waybillNo   String?

  // ✅ [추가] CJ 주소 정제 API 응답 데이터
  destCode       String? // 분류코드 (CLSFCD) - 예: 4W44
  subDestCode    String? // 서브분류코드 (SUBCLSFCD) - 예: 4g
  clsfAddr       String? // 주소약칭 (CLSFADDR) - 예: 홍길동아파트 101동
  branchName     String? // 배달점소 (CLLDLVBRANNM) - 예: 대한통운
  empNickname    String? // 배달사원 별칭 (CLLDLVEMPNICKNM)
  p2pCd          String? // 권내배송코드 (P2PCD) - P0~P50
  cjAddr         String? // CJ 정제 주소 (ADDR)
  cjAddrDetail   String? // CJ 정제 상세주소 (ADDR_DETAIL)
  cjZipNo        String? // CJ 정제 우편번호 (ZIP_NO)
  cjBranchCd     String? // 집배점코드 (CLLDLVBRANCD)
  cjRoadAddr     String? // 도로명주소 (ROADADDR)
  cjJibunAddr    String? // 지번주소 (JIBUNADDR)

  // ✅ [추가] CJ 예약 요청 시점
  requestedCjAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([orderNo], map: "JobParcel_orderNo_idx")
}

model SalesRaw {
  id String @id @default(cuid())

  // 업로드 추적
  uploadedAt DateTime @default(now())
  sourceKey  String?

  // 매장별 매출에 필요한 최소 컬럼
  saleDate    DateTime // 일 단위(시간은 00:00:00로 저장 권장)
  storeCode   String
  storeName   String?
  productType String? // 상품타입 (예: 신발, 지비츠, 기타)
  itemCode    String? // 단품코드
  codeName    String? // 코드명

  qty    Int @default(0)
  amount Int // 원 단위 Int

  // 조회 성능용 인덱스
  @@index([saleDate])
  @@index([storeCode, saleDate])
}

// CJ 대한통운 1Day Token 저장
model CjToken {
  id        String   @id @default(cuid())
  tokenNum  String   @unique // = TOKEN_NUM
  expiresAt DateTime // = TOKEN_EXPRTN_DTM 파싱값

  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// CJ 송장/예약접수 결과 (WMS Job 1:1)
model CjShipment {
  id String @id @default(cuid())

  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // CJ 키/값(필요한 것만 최소 저장)
  invcNo    String? // 운송장번호 (INVC_NO)
  custUseNo String? // 주문/내부관리번호 (CUST_USE_NO)
  rcptYmd   String? // 접수일자 (RCPT_YMD)
  mpckKey   String? // 묶음키 (MPCK_KEY)

  // 추적/감사용 원문 저장
  reqInvcNoJson Json?
  regBookJson   Json?
  cjResJson     Json?

  // 취소 시점
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invcNo])
  @@index([custUseNo])
}

// ==========================================
// 달력 이벤트 (Firebase → PostgreSQL 마이그레이션)
// ==========================================
model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime @db.Date  // 날짜만 저장 (시간 무시)

  // 작성자 (Employee 연결)
  createdById String
  createdBy   Employee @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date], map: "Event_date_idx")
  @@index([createdById], map: "Event_createdById_idx")
}

// ==========================================
// 게시판 (Firebase → PostgreSQL 마이그레이션)
// ==========================================
model BoardPost {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text

  // 작성자 (Employee 연결)
  authorId    String
  author      Employee @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // 첨부파일 (JSON 배열로 저장)
  images      Json?    // ["url1", "url2", ...]
  files       Json?    // [{name, url, type, size}, ...]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId], map: "BoardPost_authorId_idx")
  @@index([createdAt], map: "BoardPost_createdAt_idx")
}

// ==========================================
// 공지 메시지 (Firebase → PostgreSQL 마이그레이션)
// ==========================================

// 공지 대상 타입
enum MessageTargetType {
  ALL       // 전체
  STORE     // 특정 매장
  HQ_DEPT   // 본사 부서
}

model Message {
  id          String   @id @default(cuid())
  title       String
  body        String   @db.Text

  // 대상 설정
  targetType     MessageTargetType @default(ALL)
  targetStoreIds Json?    // ["storeId1", "storeId2", ...] - STORE 타입용
  targetDeptCodes Json?   // ["부서명1", "부서명2", ...] - HQ_DEPT 타입용

  // 작성자 (Employee 연결)
  authorId    String
  author      Employee @relation("MessageAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  receipts    Receipt[]

  @@index([authorId], map: "Message_authorId_idx")
  @@index([createdAt], map: "Message_createdAt_idx")
  @@index([targetType], map: "Message_targetType_idx")
}

// 공지 수신/읽음 기록
model Receipt {
  id          String   @id @default(cuid())
  messageId   String
  employeeId  String   // 수신자

  read        Boolean  @default(false)
  readAt      DateTime?

  // 발송 시점의 푸시 토큰 (재발송용)
  pushTokenAtSend String?

  createdAt   DateTime @default(now())

  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  employee    Employee @relation("ReceiptEmployee", fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([messageId, employeeId], map: "Receipt_messageId_employeeId_key")
  @@index([messageId], map: "Receipt_messageId_idx")
  @@index([employeeId], map: "Receipt_employeeId_idx")
  @@index([read], map: "Receipt_read_idx")
}

// ==========================================
// 결재 시스템 (Firebase → PostgreSQL 마이그레이션)
// ==========================================

// 결재 문서 종류
enum ApprovalType {
  VACATION   // 휴가 신청서
  EXPENSE    // 지출 결의서
  REPORT     // 업무 보고서
  GENERAL    // 범용 서류
}

// 결재 문서 상태
enum ApprovalStatus {
  DRAFT      // 임시저장
  PENDING    // 진행 중
  APPROVED   // 승인 완료
  REJECTED   // 반려됨
}

// 승인자 상태
enum ApproverStatus {
  PENDING    // 대기 중
  APPROVED   // 승인함
  REJECTED   // 반려함
}

model Approval {
  id          String   @id @default(cuid())

  // 기안자 정보
  authorId    String
  author      Employee @relation("ApprovalAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  department  String?  // 기안자 부서 (스냅샷)

  // 문서 정보
  type        ApprovalType    @default(GENERAL)
  title       String
  content     String   @db.Text

  // 서류별 상세 정보 (JSON)
  details     Json?    // VacationDetails | ExpenseDetails | ReportDetails

  // 결재선 정보
  approvers   ApprovalApprover[]

  // 첨부 파일
  attachments ApprovalAttachment[]

  // 상태
  status      ApprovalStatus @default(PENDING)
  currentStep Int      @default(1)  // 현재 승인 단계 (1부터 시작)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([authorId], map: "Approval_authorId_idx")
  @@index([status], map: "Approval_status_idx")
  @@index([createdAt], map: "Approval_createdAt_idx")
  @@index([type], map: "Approval_type_idx")
}

// 결재 승인자
model ApprovalApprover {
  id          String   @id @default(cuid())
  approvalId  String
  approval    Approval @relation(fields: [approvalId], references: [id], onDelete: Cascade)

  order       Int      // 승인 순서 (1부터)
  employeeId  String
  employee    Employee @relation("ApprovalApprover", fields: [employeeId], references: [id], onDelete: Cascade)

  name        String   // 승인자 이름 (스냅샷)
  department  String?  // 승인자 부서 (스냅샷)

  status      ApproverStatus @default(PENDING)
  comment     String?        // 승인/반려 의견
  processedAt DateTime?      // 처리 시간

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([approvalId, order], map: "ApprovalApprover_approvalId_order_key")
  @@index([approvalId], map: "ApprovalApprover_approvalId_idx")
  @@index([employeeId], map: "ApprovalApprover_employeeId_idx")
  @@index([status], map: "ApprovalApprover_status_idx")
}

// 결재 첨부파일
model ApprovalAttachment {
  id          String   @id @default(cuid())
  approvalId  String
  approval    Approval @relation(fields: [approvalId], references: [id], onDelete: Cascade)

  name        String
  url         String
  type        String   // 파일 종류 (image, file)
  size        Int      // 파일 크기 (bytes)

  createdAt   DateTime @default(now())

  @@index([approvalId], map: "ApprovalAttachment_approvalId_idx")
}
